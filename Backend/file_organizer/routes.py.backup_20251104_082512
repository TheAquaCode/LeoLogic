"""
API Routes for File Organizer
"""

import os
import json
import time
from datetime import datetime
from pathlib import Path
from flask import request, jsonify
from config.settings import CONFIG_FILE
from .state import state
from .file_watcher import start_watching, stop_watching
from .file_processor import process_file
from .bulk_processor import bulk_processor
from .rag_generator import RAGGenerator


def load_config():
    """Load watched folders and categories from disk"""
    if os.path.exists(CONFIG_FILE):
        with open(CONFIG_FILE, "r") as f:
            config = json.load(f)
            state.watched_folders = config.get("watched_folders", [])
            state.categories = config.get("categories", [])
            print(f"üìÇ Loaded {len(state.watched_folders)} watched folders")
            print(f"üè∑Ô∏è  Loaded {len(state.categories)} categories")


def save_config():
    """Save watched folders and categories"""
    config = {
        "watched_folders": state.watched_folders,
        "categories": state.categories
    }
    with open(CONFIG_FILE, "w") as f:
        json.dump(config, f, indent=2)


def register_routes(app):
    """Register all API routes"""
    
    @app.route("/api/health", methods=["GET"])
    def health():
        return jsonify({
            "status": "online",
            "initialized": state.is_initialized,
            "stats": state.processing_stats
        })

    # Watched Folders
    @app.route("/api/watched-folders", methods=["GET"])
    def get_folders():
        return jsonify(state.watched_folders)

    @app.route("/api/watched-folders", methods=["POST"])
    def add_folder():
        data = request.json
        folder = {
            "id": int(time.time() * 1000),
            "name": data.get("name"),
            "path": data.get("path"),
            "status": "Active"
        }
        state.watched_folders.append(folder)
        save_config()
        start_watching(folder["id"], folder["path"])
        return jsonify(folder)

    @app.route("/api/watched-folders/<int:folder_id>/toggle", methods=["POST"])
    def toggle_folder(folder_id):
        folder = next((f for f in state.watched_folders if f["id"] == folder_id), None)
        if folder:
            folder["status"] = "Paused" if folder["status"] == "Active" else "Active"
            if folder["status"] == "Active":
                start_watching(folder["id"], folder["path"])
            else:
                stop_watching(folder["id"])
            save_config()
            return jsonify(folder)
        return jsonify({"error": "Folder not found"}), 404

    # Categories
    @app.route("/api/categories", methods=["GET"])
    def get_categories():
        return jsonify(state.categories)

    @app.route("/api/categories", methods=["POST"])
    def add_category():
        data = request.json
        category = {
            "id": int(time.time() * 1000),
            "name": data.get("name"),
            "path": data.get("path")
        }
        state.categories.append(category)
        save_config()
        return jsonify(category)

    # Manual folder processing
    @app.route("/api/process-folder/<int:folder_id>", methods=["POST"])
    def process_folder_route(folder_id):
        folder = next((f for f in state.watched_folders if f["id"] == folder_id), None)
        if not folder or not Path(folder["path"]).exists():
            return jsonify({"error": "Folder not found"}), 404
        results = []
        for file_path in Path(folder["path"]).glob("*"):
            if file_path.is_file():
                results.append(process_file(str(file_path), folder_id))
        return jsonify({"processed": len(results), "results": results})
    
    # RAG Search (for chatbot integration)
    @app.route("/api/rag/search", methods=["POST"])
    def search_rag():
        query = request.json.get("query", "")
        max_results = request.json.get("max_results", 5)
        
        if not query:
            return jsonify({"error": "Query required"}), 400
        
        results = RAGGenerator.search_rag(query, max_results)
        return jsonify({"results": results})
    
    # Get processing statistics
    @app.route("/api/stats", methods=["GET"])
    def get_stats():
        return jsonify(state.processing_stats)
    
    # Bulk processing with progress
    @app.route("/api/process-folder-bulk/<int:folder_id>", methods=["POST"])
    def process_folder_bulk(folder_id):
        """Process entire folder with multi-threading"""
        folder = next((f for f in state.watched_folders if f["id"] == folder_id), None)
        if not folder or not Path(folder["path"]).exists():
            return jsonify({"error": "Folder not found"}), 404
        
        # Get all files
        file_paths = [str(p) for p in Path(folder["path"]).glob("*") if p.is_file()]
        
        if not file_paths:
            return jsonify({"error": "No files found"}), 404
        
        # Process with bulk processor
        result = bulk_processor.process_files(file_paths, folder_id)
        return jsonify(result)
    
    # Progress tracking
    @app.route("/api/progress", methods=["GET"])
    def get_progress():
        """Get current processing progress"""
        return jsonify({
            "queue_length": len(state.processing_queue),
            "bulk_progress": bulk_processor.get_progress(),
            "stats": state.processing_stats
        })
    
    # Upload multiple files
    @app.route("/api/upload-bulk", methods=["POST"])
    def upload_bulk():
        """Upload and process multiple files"""
        from werkzeug.utils import secure_filename
        from config.settings import DATA_DIR
        
        if 'files' not in request.files:
            return jsonify({"error": "No files provided"}), 400
        
        files = request.files.getlist('files')
        folder_id = int(request.form.get('folder_id', 0))
        
        # Save files to temp directory
        temp_dir = Path(DATA_DIR) / "temp_uploads"
        temp_dir.mkdir(exist_ok=True)
        
        file_paths = []
        for file in files:
            if file.filename:
                filename = secure_filename(file.filename)
                file_path = temp_dir / filename
                file.save(file_path)
                file_paths.append(str(file_path))
        
        # Process with bulk processor
        result = bulk_processor.process_files(file_paths, folder_id)
        
        return jsonify(result)
    
    # Get move reports
    @app.route("/api/move-reports", methods=["GET"])
    def get_move_reports():
        """List all move reports"""
        from config.settings import MOVE_LOGS_DIR
        
        reports = []
        for report_file in sorted(MOVE_LOGS_DIR.glob("*.txt"), reverse=True):
            reports.append({
                "filename": report_file.name,
                "path": str(report_file),
                "created": datetime.fromtimestamp(report_file.stat().st_mtime).isoformat()
            })
        
        return jsonify({"reports": reports})
    
    # Download move report
    @app.route("/api/move-reports/<filename>", methods=["GET"])
    def download_move_report(filename):
        """Download a specific move report"""
        from config.settings import MOVE_LOGS_DIR
        from flask import send_file
        
        report_path = MOVE_LOGS_DIR / filename
        
        if not report_path.exists():
            return jsonify({"error": "Report not found"}), 404
        
        return send_file(report_path, as_attachment=True)
